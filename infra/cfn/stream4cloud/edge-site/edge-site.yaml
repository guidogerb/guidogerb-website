AWSTemplateFormatVersion: '2010-09-09'
Description: Stream4Cloud Edge Site - S3 + CloudFront (OAC) + optional Route53
Parameters:
  SiteDomainName:
    Type: String
    Description: Fully qualified domain name for this site (e.g., site-a.example.com or example.com)
  CertificateArn:
    Type: String
    Description: ACM certificate ARN in us-east-1 for CloudFront
  HostedZoneId:
    Type: String
    Default: ""
    Description: Optional Route53 HostedZoneId for SiteDomainName. Leave blank to skip DNS record creation.
  BucketName:
    Type: String
    Default: ""
    Description: Optional custom S3 bucket name (auto-generated if blank)
  LoggingBucketName:
    Type: String
    Default: ""
    Description: Optional S3 bucket name for CloudFront logs (if blank, logging disabled)

Conditions:
  HasHostedZone: !Not [ !Equals [ !Ref HostedZoneId, "" ] ]
  HasCustomBucketName: !Not [ !Equals [ !Ref BucketName, "" ] ]
  HasLogging: !Not [ !Equals [ !Ref LoggingBucketName, "" ] ]

Resources:
  SiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !If [HasCustomBucketName, !Ref BucketName, !Ref AWS::NoValue]
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled

  SiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref SiteBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCloudFrontServicePrincipalReadOnly
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action:
              - s3:GetObject
              - s3:ListBucket
            Resource:
              - !Sub "${SiteBucket.Arn}"
              - !Sub "${SiteBucket.Arn}/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${Distribution}"
    DependsOn: Distribution

  OriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "oac-${SiteDomainName}"
        Description: Access control for S3 origin
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  Distribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        IPV6Enabled: true
        Comment: !Sub "Stream4Cloud edge for ${SiteDomainName}"
        DefaultRootObject: index.html
        Aliases:
          - !Ref SiteDomainName
        Origins:
          - Id: s3-origin
            DomainName: !GetAtt SiteBucket.RegionalDomainName
            S3OriginConfig: {}
            OriginAccessControlId: !Ref OriginAccessControl
        DefaultCacheBehavior:
          TargetOriginId: s3-origin
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6   # CachingOptimized
          Compress: true
        PriceClass: PriceClass_100
        Logging:
          !If
            - HasLogging
            - Bucket: !Sub "${LoggingBucketName}.s3.amazonaws.com"
              IncludeCookies: false
              Prefix: !Sub "cloudfront/${SiteDomainName}/"
            - !Ref AWS::NoValue
        ViewerCertificate:
          AcmCertificateArn: !Ref CertificateArn
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        CustomErrorResponses:
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html

  DNSRecord:
    Condition: HasHostedZone
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref SiteDomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt Distribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2   # CloudFront hosted zone ID (global)

Outputs:
  SiteBucketName:
    Value: !Ref SiteBucket
  CloudFrontDomainName:
    Value: !GetAtt Distribution.DomainName
  CloudFrontDistributionId:
    Value: !Ref Distribution
